// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum ListingStatus {
  PENDING
  ACTIVE
  REJECTED
  PASSIVE
  DELETED
  EXPIRED
  SOLD
}

// User Model
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  phone         String?
  avatar        String?
  password      String?
  role          String?   @default("INDIVIDUAL")
  status        String?   @default("ACTIVE")
  emailVerified DateTime?
  phoneVerified Boolean   @default(false)
  phoneVerifiedAt DateTime?
  tcIdentityNo  String?
  identityDoc   String?   // URL to identity document
  identityVerified Boolean @default(false)
  identityVerifiedAt DateTime?
  identityVerificationStatus String @default("NOT_STARTED") // NOT_STARTED, PENDING, VERIFIED, REJECTED
  
  // Corporate Verification
  taxNumber     String?
  taxOffice     String?
  taxPlateDoc   String?
  companyRegistryNo String? // Sicil Numarası
  companyEstablishmentDoc String? // Kuruluş Evrakları (Sicil Gazetesi vb.)
  corporateVerified Boolean @default(false)
  corporateVerificationStatus String @default("NOT_STARTED")

  twoFactorEnabled Boolean @default(false)
  
  // Profile & Settings
  bio                   String?
  notificationPreferences Json?   // Stores email toggle states
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  listings      Listing[]
  favorites     Favorite[]
  dealerProfile DealerProfile?
  vehicleFeedbacks VehicleFeedback[]
  
  // Messaging Relations
  buyerConversations  Conversation[] @relation("BuyerConversations")
  sellerConversations Conversation[] @relation("SellerConversations")
  
  @@map("users")
}

model VerificationToken {
  id        String   @id @default(cuid())
  email     String
  token     String
  expires   DateTime
  createdAt DateTime @default(now())

  @@unique([email, token])
  @@map("verification_tokens")
}

model PhoneVerificationToken {
  id        String   @id @default(cuid())
  phone     String
  token     String
  expires   DateTime
  createdAt DateTime @default(now())

  @@unique([phone, token])
  @@map("phone_verification_tokens")
}

model Favorite {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  listingId String
  listing   Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, listingId])
  @@index([userId])
  @@index([listingId])
  @@map("favorites")
}

model DealerProfile {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  storeName   String
  slug        String   @unique
  phone       String
  city        String
  district    String
  taxNumber   String?
  taxPlateDoc String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("dealer_profiles")
}

// Category Model
model Category {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  icon        String?
  parentId    String?
  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")
  createdAt   DateTime   @default(now())
  
  listings    Listing[]
  stats       CategoryStats?
  
  @@map("categories")
}

// Main Listing Model
model Listing {
  id              String    @id @default(cuid())
  listingNumber   Int       @unique @default(autoincrement())
  title           String
  description     String?
  price           Int
  
  // Vehicle Details
  km              Int?
  color           String?
  year            Int?
  brand           String?
  model           String?
  fuel            String?
  gear            String?
  caseType        String?
  version         String?
  package         String?
  
  // Status
  warranty        Boolean   @default(false)
  exchange        Boolean   @default(false)
  tramer          String?
  
  // Location
  city            String?
  district        String?
  
  // Metadata
  views           Int       @default(0)
  isPremium       Boolean   @default(false)
  isActive        Boolean   @default(false)
  
  // Approval System
  status            ListingStatus @default(PENDING)
  rejectionReason   String?
  approvedAt        DateTime?
  approvedBy        String?
  deletedAt         DateTime?  // For soft delete
  
  // New Fields
  expertReports     String[]   // URLs to expert report files (PDF/Image)
  contactPreference String     @default("both") // "call", "message", "both"
  listingPackage    String?    @default("standard") // "standard", "gold", "premium"
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt()
  
  // Relations
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  categoryId      String
  category        Category  @relation(fields: [categoryId], references: [id])
  
  images          Image[]
  equipment       ListingEquipment[]
  damage          DamageReport[]
  favorites       Favorite[]
  conversations   Conversation[]
  
  @@index([userId])
  @@index([categoryId])
  @@index([createdAt])
  @@index([price])
  @@index([year])
  @@index([km])
  @@index([brand])
  @@index([model])
  @@index([status])
  @@map("listings")
}

// Image Model
model Image {
  id          String   @id @default(cuid())
  url         String
  isCover     Boolean  @default(false)
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  
  listingId   String
  listing     Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  
  @@index([listingId])
  @@map("images")
}

// Equipment/Features Model
model Equipment {
  id          String   @id @default(cuid())
  name        String   @unique
  category    String   // Safety, Interior, Exterior, Multimedia
  
  listings    ListingEquipment[]
  
  @@map("equipment")
}

// Many-to-Many relation for Listing Equipment
model ListingEquipment {
  id          String   @id @default(cuid())
  
  listingId   String
  listing     Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  
  equipmentId String
  equipment   Equipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
  
  @@unique([listingId, equipmentId])
  @@index([listingId])
  @@index([equipmentId])
  @@map("listing_equipment")
}

// Damage Report Model
model DamageReport {
  id          String   @id @default(cuid())
  part        String   // Hood, Front Left Door, etc.
  status      String   // Original, Local Paint, Painted, Changed
  description String?
  
  listingId   String
  listing     Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  
  @@index([listingId])
  @@map("damage_reports")
}

// Site-wide Statistics (Singleton - only 1 row)
model SiteStats {
  id                  String   @id @default("singleton")
  activeUsers         Int      @default(0)
  totalListings       Int      @default(0)
  newListingsToday    Int      @default(0)
  soldToday           Int      @default(0)
  lastUpdated         DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  @@map("site_stats")
}

// Category-specific Statistics (Cached)
model CategoryStats {
  id            String   @id @default(cuid())
  categoryId    String   @unique
  category      Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  listingCount  Int      @default(0)
  trend         String?  // "+12%", "-5%", etc.
  lastUpdated   DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([categoryId])
  @@map("category_stats")
}

// Eurotax Vehicle Data (Flat table for efficient filtering)
model VehicleData {
  id          String   @id @default(cuid())
  type        String   // Otomobil, Motosiklet vs. (path_1)
  year        Int      // 2025, 2024 (path_2)
  brand       String   // Audi, BMW (path_3)
  model       String   // A3, 3 Serisi (path_4)
  fuel        String?  // Benzin, Dizel (path_5)
  bodyType    String?  // Sedan, Hatchback (path_6 - Kasa Tipi)
  gear        String?  // Otomatik, Manuel (path_7)
  subModel    String?  // A3 Sedan, 320i (path_8)
  package     String?  // S Line, M Sport (path_9)
  
  // Technical Specs
  motorVolume String?  // 1598 cm3
  motorPower  String?  // 130 HP
  version     String?  // Alt Model (DB11 5.2 V12 AMR)
  
  createdAt   DateTime @default(now())
  
  @@map("vehicle_data")
  @@index([type])
  @@index([brand])
  @@index([model])
  @@index([year])
}

// Vehicle Feedback System
model VehicleFeedback {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  
  type        String   // "ERROR_REPORT" | "MISSING_VEHICLE"
  brand       String?
  model       String?
  year        Int?
  details     String   @db.Text
  
  status      String   @default("PENDING") // "PENDING", "RESOLVED", "REJECTED"
  adminNote   String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Messaging System
model Conversation {
  id        String   @id @default(cuid())
  listingId String
  listing   Listing  @relation(fields: [listingId], references: [id])
  
  buyerId   String
  buyer     User     @relation("BuyerConversations", fields: [buyerId], references: [id])
  
  sellerId  String
  seller    User     @relation("SellerConversations", fields: [sellerId], references: [id])
  
  messages  Message[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([listingId, buyerId, sellerId])
  @@map("conversations")
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  senderId       String
  content        String
  isRead         Boolean      @default(false)
  
  createdAt      DateTime     @default(now())
  
  @@map("messages")
}
